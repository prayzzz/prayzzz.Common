# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

pool:
  vmImage: 'Ubuntu 16.04'

variables:
  BuildConfiguration: Release
  Major: '1'
  Minor: '0'
  Patch: '0'
  BuildRevision: $[counter('buildrevision', 100)]
  BuildVersion: $(Major).$(Minor).$(Patch).$(BuildRevision)-$(Build.SourceBranchName)

name: $(Major).$(Minor).$(Patch).$(BuildRevision)-$(Build.SourceBranchName)

steps:
- task: DotNetCoreCLI@2
  inputs:
    command: build
    projects: '**/*.csproj'
    arguments: --configuration $(BuildConfiguration)

- task: DotNetCoreCLI@2
  inputs:
    command: test
    projects: '**/*.Test.csproj'
    arguments: --configuration $(BuildConfiguration)

# CI Package
- task: DotNetCoreCLI@2
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'))
  inputs:
      command: pack
      packagesToPack: '**/*.csproj;-:**/*.Test.csproj'
      versioningScheme: byEnvVar
      versionEnvVar: BuildVersion

# Release Package
- task: DotNetCoreCLI@2
  condition: and(succeeded(), startsWith('refs/tags/', variables['Build.SourceBranch']))
  inputs:
      command: pack
      packagesToPack: '**/*.csproj;-:**/*.Test.csproj'
      versioningScheme: byEnvVar
      versionEnvVar: Build.SourceBranchName

- task: DotNetCoreCLI@2
  condition: and(succeeded(), ne(variables['Build.Reason'], 'PullRequest'), startsWith('refs/tags/', variables['Build.SourceBranch']))
  inputs:
      command: push
      publishVstsFeed: nupkg
